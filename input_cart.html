<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/cart.css">
<title>檢視購物車</title>
<script type="text/javascript">
var storage = localStorage;
var expire_date = "2018/12/31";

window.onload = function(){
	for( i = 1 ; i < 7 ; i++){
		var fn = i;
		if( storage.getItem(i) != null ){
			var info = storage.getItem(i).split("/");
			var full_fare_num = info[1];
			if( full_fare_num > 0 ){
				var full_fare = info[0];
				var full_fare_subtotal = full_fare * full_fare_num;			
				$("table").append("<tr id='full_"+fn+"'><td class='fn_id'>"+fn+"</td><td class='icon_td'>設施icon</td><td>設施名稱</td><td class='full_td'>全票</td><td>"+expire_date+"</td><td id='full_fare_id_"+fn+"'>"+full_fare+"</td><td><input type='number' max='99' value="+full_fare_num+" id='full_fare_num_id_"+fn+"'></td><td class='sub_total' id='full_fare_subtotal_id_"+fn+"'>"+full_fare_subtotal+"</td><td class='delete_btn_td'><button class='delete_btn' id='full_fare_delete_btn_id_"+fn+"'>X</button></td></tr>");

				document.getElementById("full_fare_num_id_"+fn).onchange = changeNum;
				document.getElementById("full_fare_delete_btn_id_"+fn).onclick = deleteRowByClick;
			}
			var half_fare_num = info[3];
			if( half_fare_num > 0){
				var half_fare = info[2];
				var half_fare_subtotal = half_fare * half_fare_num;
				$("table").append("<tr id='half_"+fn+"'><td class='fn_id'>"+fn+"</td><td class='icon_td'>設施icon</td><td>設施名稱</td><td class='half_td'>半票</td><td>"+expire_date+"</td><td id='half_fare_id_"+fn+"'>"+half_fare+"</td><td><input type='number' max='99' value="+half_fare_num+" id='half_fare_num_id_"+fn+"'></td><td class='sub_total' id='half_fare_subtotal_id_"+fn+"'>"+half_fare_subtotal+"</td><td class='delete_btn_td'><button class='delete_btn' id='half_fare_delete_btn_id_"+fn+"'>X</button></td></tr>");

				document.getElementById("half_fare_num_id_"+fn).onchange = changeNum;
				document.getElementById("half_fare_delete_btn_id_"+fn).onclick = deleteRowByClick;
			}
		}
	}
	var length = document.getElementsByClassName("sub_total").length;
	var total = 0;
	for( i = 0 ; i < length ; i++){
		var sub_total = parseInt(document.getElementsByClassName("sub_total")[i].innerHTML);
		total += sub_total;
	}
		$("table").append("<tr id='cart_total_row'><td colspan='7' id='cart_total_prev'>"+"總計："+"</td><td name='cart_total' id='cart_total'>"+total+"</td><td></td></tr>");	
		document.getElementById("cart_total").innerHTML = total;

function changeNum(){
		// 單價
		var aa = this.id.replace('_num','');
		var fare = parseInt(document.getElementById(aa).innerHTML);
		// 新數量
		var num = this.value;
			if( num != 0){
				// 新subtotal
				document.getElementById(this.id.replace('num','subtotal')).innerHTML = fare*num;
				// 新total
				var length = document.getElementsByClassName("sub_total").length;
				var newTotal = 0;
				for( i = 0 ; i < length ; i++){
					var sub_total = parseInt(document.getElementsByClassName("sub_total")[i].innerHTML);
				newTotal += sub_total;
				document.getElementById("cart_total").innerHTML = newTotal;
				}

				// 更改localStorage內容
				// 修改為全票
				if( this.id.search("full") == 0){
					var cc = storage.getItem(this.id.substr(this.id.length-1,1)).split("/");
					cc[1] = this.value;
					storage.setItem(this.id.substr(this.id.length-1,1),cc.join("/"));
				}
				// 修改為半票
				else{
					var cc = storage.getItem(this.id.substr(this.id.length-1,1)).split("/");
					cc[3] = this.value;
					storage.setItem(this.id.substr(this.id.length-1,1),cc.join("/"));
				}
			}else{
				var confirm_status = confirm("您確定要刪除這張票券？");
				if( confirm_status == true){
					var ff = this.id;
					deleteRow(ff);
				}else{
					this.value = 1;
					alert(this.value);
				}
			}
}

function deleteRow(changeTOZero){
	var confirm = confirm("確定要刪除票券?");
	if( confirm == true ){
	if( changeTOZero != null){
		var temp1 = changeTOZero.replace("_fare_num_id","");
		document.getElementById(temp1).remove();
			// 清除localstorage
			// 修改為全票
			if( temp1.search("full") == 0){
				var cc = storage.getItem(temp1.substr(temp1.length-1,1)).split("/");
				cc[1] = 0;
				storage.setItem(temp1.substr(temp1.length-1,1),cc.join("/"));
			}
			// 修改為半票
			else{
				var cc = storage.getItem(temp1.substr(temp1.length-1,1)).split("/");
				cc[3] = 0;
				storage.setItem(temp1.substr(temp1.length-1,1),cc.join("/"));
			}
	}	
	// 重新計算總額
	var length = document.getElementsByClassName("sub_total").length;
	var total = 0;
	for( i = 0 ; i < length ; i++){
		var sub_total = parseInt(document.getElementsByClassName("sub_total")[i].innerHTML);
			total += sub_total;
	}
	document.getElementById("cart_total").innerHTML = total;
}
}
function deleteRowByClick(){
	alert("sdss");
	var temp2 = this.id.replace("_fare_delete_btn_id","");
	document.getElementById(temp2).remove();
	// 修改為全票
	if( this.id.search("full") == 0){
		var cc = storage.getItem(this.id.substr(this.id.length-1,1)).split("/");
		cc[1] = 0;
		storage.setItem(this.id.substr(this.id.length-1,1),cc.join("/"));
	}
	// 修改為半票
	else{
		var cc = storage.getItem(this.id.substr(this.id.length-1,1)).split("/");
		cc[3] = 0;
		storage.setItem(this.id.substr(this.id.length-1,1),cc.join("/"));
	}
	// 重新計算總額
	var length = document.getElementsByClassName("sub_total").length;
	var total = 0;
	for( i = 0 ; i < length ; i++){
		var sub_total = parseInt(document.getElementsByClassName("sub_total")[i].innerHTML);
			total += sub_total;
	}
	document.getElementById("cart_total").innerHTML = total;
}

document.getElementById("nextStep").onclick = nextStep;
function nextStep(){
	document.location.href="http://www.w3school.com.cn/jsref/met_win_confirm.asp";
}

loginOrNot();
function loginOrNot(){
	if( storage.getItem("memId")){
		// 已經登入 
		$("#nextStep a").attr("href","input_cart_detail.html");
	}else{
		// 尚未登入
		$("#nextStep a").attr("href","http://www.w3school.com.cn/jsref/met_win_confirm.asp");
	}
}
};
</script>
<body>
<h1>您的購物車</h1>
<form>
	<table border="1" cellspacing="0">
		<tr id="cart_header">
			<th>設施編號</th>
			<th>圖示</th>
			<th>設施名稱</th>
			<th>票種</th>
			<th>使用期限</th>
			<th id="fare_th">票價</th>
			<th style='text-align: right'>張數</th>
			<th style='text-align: right'>小計</th
			>
			<th colspan="2"></th>
		</tr>
	</table>
<div id="button">
	<button id="backToShop"><a href="buy.html">繼續購物</a></button>
	<button id="nextStep"><a href="">下一步</a></button>
</div>
</form>
<!-- 判斷是否登入，修改超連結內容 -->
<script type="text/javascript">
storage.setItem("memId","999");
</script>
</body>
</html>