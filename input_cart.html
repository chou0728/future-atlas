<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/header.css">
<link rel="stylesheet" type="text/css" href="css/cart.css">
<title>檢視購物車</title>
<script type="text/javascript">
var storage = localStorage;
var expire_date = "2018/12/31";

window.onload = function(){
	for( i = 1 ; i < 7 ; i++){
		var fn = i;
		if( storage.getItem(i) != null ){
			var info = storage.getItem(i).split("/");
			var full_fare_num = info[1];
			if( full_fare_num > 0 ){
				var full_fare = info[0];
				var full_fare_subtotal = full_fare * full_fare_num;			
				$("table").append("<tr id='full_"+fn+"'><td class='fn_id'>"+fn+"</td><td class='icon_td'>設施icon</td><td>設施名稱</td><td class='full_td'>全票</td><td>"+expire_date+"</td><td id='full_fare_id_"+fn+"'>"+full_fare+"</td><td><div class='ctrl'><div class='ctrl-button ctrl-button-decrement' id='full_decrement_"+fn+"'>-</div><div class='ctrl-counter'><input class='ctrl-counter-input' maxlength='3' type='text' value="+full_fare_num+" id='full_fare_num_id_"+fn+"'></div><div class='ctrl-button ctrl-button-increment' id='full_increment_"+fn+"'>+</div></td><td class='sub_total' id='full_fare_subtotal_id_"+fn+"'>"+full_fare_subtotal+"</td><td class='delete_btn_td'><button class='delete_btn' id='full_fare_delete_btn_id_"+fn+"'>X</button></td></tr>");

				document.getElementById("full_fare_num_id_"+fn).onchange = changeNum;
				document.getElementById("full_decrement_"+fn).onclick = minusNumPanel;
				document.getElementById("full_increment_"+fn).onclick = addNumPanel;
				document.getElementById("full_fare_delete_btn_id_"+fn).onclick = deleteRowByClick;
			}
			var half_fare_num = info[3];
			if( half_fare_num > 0){
				var half_fare = info[2];
				var half_fare_subtotal = half_fare * half_fare_num;
				$("table").append("<tr id='half_"+fn+"'><td class='fn_id'>"+fn+"</td><td class='icon_td'>設施icon</td><td>設施名稱</td><td class='half_td'>半票</td><td>"+expire_date+"</td><td id='half_fare_id_"+fn+"'>"+half_fare+"</td><td><div class='ctrl'><div class='ctrl-button ctrl-button-decrement' id='half_decrement_"+fn+"'>-</div><div class='ctrl-counter'><input class='ctrl-counter-input' maxlength='3' type='text' value="+half_fare_num+" id='half_fare_num_id_"+fn+"'></div><div class='ctrl-button ctrl-button-increment' id='half_increment_"+fn+"'>+</div></td><td class='sub_total' id='half_fare_subtotal_id_"+fn+"'>"+half_fare_subtotal+"</td><td class='delete_btn_td'><button class='delete_btn' id='half_fare_delete_btn_id_"+fn+"'>X</button></td></tr>");

				document.getElementById("half_fare_num_id_"+fn).onchange = changeNum;
				document.getElementById("half_decrement_"+fn).onclick = minusNumPanel;
				document.getElementById("half_increment_"+fn).onclick = addNumPanel;
				document.getElementById("half_fare_delete_btn_id_"+fn).onclick = deleteRowByClick;
			}
		}
	}
	// 加總
	var length = document.getElementsByClassName("sub_total").length;
	var total = 0;
	for( i = 0 ; i < length ; i++){
		var sub_total = parseInt(document.getElementsByClassName("sub_total")[i].innerHTML);
		total += sub_total;
	}
		$("table").append("<tr id='cart_total_row'><td colspan='7' id='cart_total_prev'>"+"總計："+"</td><td name='cart_total' id='cart_total'>"+total+"</td><td></td></tr>");	
		document.getElementById("cart_total").innerHTML = total;


// 加減控制盤
function addNumPanel(){
	alert("家!");
}
function minusNumPanel(){
	console.log("檢!");
	console.log(this.id);
	alert(this.nextSibling.childNodes.value);
	var a = this.id.replace('_decrement','_fare_num_id').toString();
	console.log(a);
	console.log(document.getElementById("a").value());
}


function changeNum(){
		// 單價
		var aa = this.id.replace('_num','');
		var fare = parseInt(document.getElementById(aa).innerHTML);
		// 新數量
		var num = this.value;
			if( num != 0){
				// 新subtotal
				document.getElementById(this.id.replace('num','subtotal')).innerHTML = fare*num;
				// 新total
				var length = document.getElementsByClassName("sub_total").length;
				var newTotal = 0;
				for( i = 0 ; i < length ; i++){
					var sub_total = parseInt(document.getElementsByClassName("sub_total")[i].innerHTML);
				newTotal += sub_total;
				document.getElementById("cart_total").innerHTML = newTotal;
				}

				// 更改localStorage內容
				// 修改為全票
				if( this.id.search("full") == 0){
					var cc = storage.getItem(this.id.substr(this.id.length-1,1)).split("/");
					cc[1] = this.value;
					storage.setItem(this.id.substr(this.id.length-1,1),cc.join("/"));
				}
				// 修改為半票
				else{
					var cc = storage.getItem(this.id.substr(this.id.length-1,1)).split("/");
					cc[3] = this.value;
					storage.setItem(this.id.substr(this.id.length-1,1),cc.join("/"));
				}
			}else{
				var confirm_status = confirm("您確定要刪除這張票券？");
				if( confirm_status == true){
					var ff = this.id;
					deleteRow(ff);
				}else{
					this.value = 1;
					alert(this.value);
				}
			}
}

function deleteRow(changeTOZero){
	var confirm = confirm("確定要刪除票券?");
	if( confirm == true ){
	if( changeTOZero != null){
		var temp1 = changeTOZero.replace("_fare_num_id","");
		document.getElementById(temp1).remove();
			// 清除localstorage
			// 修改為全票
			if( temp1.search("full") == 0){
				var cc = storage.getItem(temp1.substr(temp1.length-1,1)).split("/");
				cc[1] = 0;
				storage.setItem(temp1.substr(temp1.length-1,1),cc.join("/"));
			}
			// 修改為半票
			else{
				var cc = storage.getItem(temp1.substr(temp1.length-1,1)).split("/");
				cc[3] = 0;
				storage.setItem(temp1.substr(temp1.length-1,1),cc.join("/"));
			}
	}	
	// 重新計算總額
	var length = document.getElementsByClassName("sub_total").length;
	var total = 0;
	for( i = 0 ; i < length ; i++){
		var sub_total = parseInt(document.getElementsByClassName("sub_total")[i].innerHTML);
			total += sub_total;
	}
	document.getElementById("cart_total").innerHTML = total;
}
}
function deleteRowByClick(){
	alert("sdss");
	var temp2 = this.id.replace("_fare_delete_btn_id","");
	document.getElementById(temp2).remove();
	// 修改為全票
	if( this.id.search("full") == 0){
		var cc = storage.getItem(this.id.substr(this.id.length-1,1)).split("/");
		cc[1] = 0;
		storage.setItem(this.id.substr(this.id.length-1,1),cc.join("/"));
	}
	// 修改為半票
	else{
		var cc = storage.getItem(this.id.substr(this.id.length-1,1)).split("/");
		cc[3] = 0;
		storage.setItem(this.id.substr(this.id.length-1,1),cc.join("/"));
	}
	// 重新計算總額
	var length = document.getElementsByClassName("sub_total").length;
	var total = 0;
	for( i = 0 ; i < length ; i++){
		var sub_total = parseInt(document.getElementsByClassName("sub_total")[i].innerHTML);
			total += sub_total;
	}
	document.getElementById("cart_total").innerHTML = total;
}

document.getElementById("nextStep").onclick = nextStep;
function nextStep(){
	document.location.href="http://www.w3school.com.cn/jsref/met_win_confirm.asp";
}

loginOrNot();
function loginOrNot(){
	if( storage.getItem("memId")){
		// 已經登入 
		$("#nextStep a").attr("href","input_cart_detail.html");
	}else{
		// 尚未登入
		$("#nextStep a").attr("href","http://www.w3school.com.cn/jsref/met_win_confirm.asp");
	}
}
};
</script>
<body>
<div class="header">
	<ul class="ul_top">
		<li class="li_top">
			<a href="SignUp.html">註冊</a>
		</li>
		<li class="li_top">
			<a href="#" id="singUpBtn">登入</a>
		</li>
		<li class="li_top">
			<a href="input_cart.html">購物車</a>
		</li>
	</ul>
</div>
<div class="nav">
	<div class="ul_box">
		<ul class="ul_left">
			<li>
				<a href="Theaterbuyticket.html">劇場購票</a>
			</li>
			<li>
				<a href="facilityBuyTicket.html">設施購票</a>
			</li>
			<li>
				<a href="facilityInfo.html">設施介紹</a>
			</li>
		</ul>
		<h1 style="display: none">FutureAtlas_未來主題樂園</h1>
		<a href="index.html#page1">
			<img src="img/LOGO.png" class="logo">
		</a>
		<ul class="ul_right">
			<li>
				<a href="index.html#page2">園區地圖</a>
			</li>
			<li>
				<a href="activity.html">活動月曆</a>
			</li>
			<li>
				<a href="robot.html">諮詢專區</a>
			</li>
		</ul>
	</div>
	<div class="navOpenBtn"><!-- RWD left btn-->
		<div class="ham"></div>
		<div class="ham"></div>
		<div class="ham"></div>
		<div class="ham"></div>
	</div>
</div>
<div class="headerOpenBtn"><!-- RWD right btn-->
	<img src="img/memberBtnM.png" class="memIcon">
	<img src="img/ticketicon.png" class="ticketIcon">
	<div class="blueScreen"></div>
</div>

	<!-- header end-->
<div id="cartWrapper">
	<div id="cartTitle">您的購物車</div>
	<form>
		<table border="1" cellspacing="0">
			<tr id="cart_header">
				<th id="fn_th">設施編號</th>
				<th id="icon_th">圖示</th>
				<th id="fname_th">設施名稱</th>
				<th id="tt_th">票種</th>
				<th id="expire_date_th">使用期限</th>
				<th id="fare_th">票價</th>
				<th id="tn_th" style='text-align: right'>張數</th>
				<th id="subtotal_th" style='text-align: right'>小計</th
				>
				<th colspan="2"></th>
			</tr>
		</table>
	<div id="button">
		<button id="backToShop"><a href="facilityBuyTicket.html">繼續購物</a></button>
		<button id="nextStep"><a href="">下一步</a></button>
	</div>
	</form>
</div>

<script type="text/javascript">
// 判斷是否登入，修改超連結內容
storage.setItem("memId","999");
</script>
<script src="js/00nav.js"></script>
</body>
</html>